{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "did",
  "title": "Battery-Ecosystem DID Document",
  "description": "Minimal on-chain DID record with a revocation tag.",
  "type": "object",
  "required": ["@context", "id", "verificationMethod", "timestamp", "revoked"],
  "additionalProperties": false,
  "properties": {
    "@context": {
      "type": "array",
      "items": {
        "type": "string",
        "format": "uri",
        "enum": [
          "https://www.w3.org/2018/credentials/v1",
          "http://localhost:8443/docs/did.schema.html"
        ]
      },
      "minItems": 2,
      "maxItems": 2,
      "uniqueItems": true
    },
    "id": { "$ref": "common.defs.schema.json#/definitions/DID" },
    "verificationMethod": { "$ref": "#/definitions/verificationMethod" },
    "service": {
      "type": "array",
      "items": {
        "oneOf": [
          { "$ref": "#/definitions/BatterypassApiService" },
          { "$ref": "#/definitions/HandleDidService" }
        ]
      }
    },
    "timestamp": { "$ref": "common.defs.schema.json#/definitions/DateTime" },
    "revoked": {
      "type": "boolean",
      "description" : "A revoked flag indicating if an DID is no longer valid."
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "id": { "pattern": "^did:batterypass:bms" }
        }
      },
      "then": {
        "required": ["service"],
        "properties": {
          "service": {
            "items": { "$ref": "#/definitions/BatterypassApiService" },
            "minItems": 1
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "id": {
            "pattern": "^did:batterypass:cloud"
          }
        }
      },
      "then": {
        "required": ["service"],
        "properties": {
          "service": {
            "items": {
              "$ref": "#/definitions/BatterypassApiService"
            },
            "minItems": 1,
            "maxItems": 1
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "id": { "pattern": "^did:batterypass:(eu|oem)" }
        }
      },
      "then": {
        "required": ["service"],
        "properties": {
          "service": {
            "items": { "$ref": "#/definitions/HandleDidService" },
            "minItems": 1,
            "maxItems": 1
          }
        }
      }
    }
  ],
  "definitions": {
    "verificationMethod": {
      "type": "object",
      "required": ["id", "type", "controller", "publicKeyMultibase"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string" },
        "controller": { "type": "string" },
        "publicKeyMultibase": { "type": "string" }
      }
    },
    "BatterypassApiService": {
      "type": "object",
      "required": ["id", "type", "serviceEndpoint"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^did:batterypass:(bms|cloud):[A-Za-z0-9._-]+#batterypassApi(-[a-zA-Z0-9._-]+)?"
        },
        "type": { "const": "BatteryPassAPI" },
        "serviceEndpoint": { "type": "string" }
      }
    },
    "HandleDidService": {
      "type": "object",
      "required": ["id", "type", "serviceEndpoint"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^did:batterypass:(oem|eu):[A-Za-z0-9._-]+#handleDid$"
        },
        "type": { "const": "HandleDID" },
        "serviceEndpoint": { "type": "string" }
      }
    }
  }
}
